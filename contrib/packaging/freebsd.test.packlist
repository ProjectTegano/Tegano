#!/bin/sh

VERSION=0.0.1
PKGBUILD=$HOME/bsdbuild
ORIG_ARCH=`uname -m`
if test "x$ORIG_ARCH" = "xamd64"; then
	ARCH="x86_64"
	FREEIMAGE="WITH_LOCAL_FREEIMAGE=1"
else
if test "x$ORIG_ARCH" = "xi386"; then
	ARCH="i686"
	# Freeimage is broken on 32-bit FreeBSD (because of gcc)
	FREEIMAGE=""
else
	echo "ERROR: Unknown FreeBSD architecture '$ORIG_ARCH'"
	exit 1
fi
fi

check_for_errors( )
{
	RET=$?
	if test $RET -gt 0; then
		echo "Packaging failed."
		exit 1
	fi
}

OS_VERSION=`uname -r`
case $OS_VERSION in
	8.*)
		FREEIMAGE=""
		;;
esac

cp packaging/freebsd/comment $PKGBUILD/PKG/wolframe-$VERSION/.
cp packaging/freebsd/description $PKGBUILD/PKG/wolframe-$VERSION/.
cp packaging/freebsd/packlist $PKGBUILD/PKG/wolframe-$VERSION/.
if test "x$FREEIMAGE" = "xWITH_LOCAL_FREEIMAGE=1"; then
	cat packaging/freebsd/packlist.freeimage >> $PKGBUILD/PKG/wolframe-$VERSION/packlist
fi
cat packaging/freebsd/packlist.tail >> $PKGBUILD/PKG/wolframe-$VERSION/packlist
cp packaging/freebsd/iscript $PKGBUILD/PKG/wolframe-$VERSION/.
cp packaging/freebsd/dscript $PKGBUILD/PKG/wolframe-$VERSION/.
cp packaging/freebsd/wolframe.conf $PKGBUILD/PKG/wolframe-$VERSION/usr/local/etc/wolframe/.
rm -rf $PKGBUILD/PKG/wolframe-$VERSION/usr/local/etc/rc.d
mkdir $PKGBUILD/PKG/wolframe-$VERSION/usr/local/etc/rc.d
cp packaging/freebsd/wolframed $PKGBUILD/PKG/wolframe-$VERSION/usr/local/etc/rc.d/.
chmod 0775 $PKGBUILD/PKG/wolframe-$VERSION/usr/local/etc/rc.d/wolframed

cd $PKGBUILD

pkg_create -S $PKGBUILD -z -v \
	-c PKG/wolframe-$VERSION/comment \
	-d PKG/wolframe-$VERSION/description \
	-f PKG/wolframe-$VERSION/packlist \
	-i PKG/wolframe-$VERSION/iscript \
	-k PKG/wolframe-$VERSION/dscript \
	$PKGBUILD/PKGS/$ARCH/wolframe-$VERSION-$ARCH.tgz
check_for_errors

echo "Packaging succeeded."

pkg_info -L PKGS/$ARCH/wolframe-$VERSION-$ARCH.tgz | sort > in
cd $PKGBUILD/PKG/wolframe-$VERSION
find . -type f | sort | sed 's|^\.||g' > ../../now

echo "Differences in package and in installation root:"
cd $PKGBUILD
diff now in

exit 0
