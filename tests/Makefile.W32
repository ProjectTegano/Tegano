TOPDIR = ..

SUBDIRS = modules AAAA bignum

# all broken on windows due to working telnet
#!IFDEF WITH_EXPECT
#SUBDIRS = \
#	$(SUBDIRS) expect
#!ENDIF

!IFDEF WITH_LIBXML2
SUBDIRS = \
	$(SUBDIRS) libxml2
!ENDIF

!IFDEF WITH_LIBXSLT
!IFDEF WITH_LIBXML2
SUBDIRS = \
	$(SUBDIRS) libxslt
!ENDIF
!ENDIF

!IFDEF WITH_LIBHPDF
SUBDIRS = \
	$(SUBDIRS) libhpdf
!ENDIF

# MSXML
!IFDEF WITH_MSXML
SUBDIRS = \
	$(SUBDIRS) msxml msxslt
!ENDIF

# XMLLite
!IFDEF WITH_XMLLITE
SUBDIRS = \
	$(SUBDIRS) xmllite
!ENDIF


!INCLUDE $(TOPDIR)\makefiles\nmake\platform.mk

INCLUDE_CXXFLAGS = \
	/D_WIN32_WINNT=0x504

INCLUDE_DIRS = \
	/I$(TOPDIR)\include /I. \
	/I$(TOPDIR)\src \
	/I"$(BOOST_INCLUDE_DIR)" \
	/I"$(PLATFORM_SDK_DIR)\Include" \
	/I$(TOPDIR)\gtest\include

# Note: libraries are picked automatically on Windows!
INCLUDE_LDFLAGS = \
	$(SDK_LDFLAGS) $(BOOST_LDFLAGS)

INCLUDE_LIBS = \
	Advapi32.lib Ws2_32.lib \
	$(TOPDIR)\gtest\gtest-all.obj \
	$(TOPDIR)\src\libwolframe\wolframe.lib

# libxml2
!IFDEF WITH_LIBXML2

INCLUDE_CXXFLAGS = \
	$(INCLUDE_CXXFLAGS) /DWITH_LIBXML2

INCLUDE_DIRS = \
	$(INCLUDE_DIRS) /I. /I"$(LIBXML2_DIR)\include" /I"$(LIBXML2_DIR)\include\libxml" \
	/I"$(WIN_ICONV_DIR)"

INCLUDE_LIBS = \
	$(INCLUDE_LIBS) "$(LIBXML2_DIR)\lib\libxml2.lib"

!ENDIF

TEST_CPP_BINS = \
	threadLeakTest.exe \
	testNamedRetVal.exe \
	versionTest.exe \
	testMethodMemberPointerTemplate.exe \
	counterTest.exe \
	resolvePathTest.exe \
	testBoostPath.exe \
	singletonTest.exe \
	byte2hexTest.exe \
	CRAMtest.exe \
	testSHA2.exe \
	poolTest.exe \
	logTest.exe \
	protocolArgumentParsing.exe \
	configStructParser.exe \
	configValueParser.exe \
	testTimers.exe \
	testRand.exe

OBJS = \

all: $(OBJS) $(CPP_BINS)

!INCLUDE $(TOPDIR)\makefiles\nmake\sub.mk

threadLeakTest.exe: threadLeakTest.obj $(TOPDIR)\src\wolframe.lib
testNamedRetVal.exe: testNamedRetVal.obj
testMethodMemberPointerTemplate.exe: testMethodMemberPointerTemplate.obj
versionTest.exe: versionTest.obj $(TOPDIR)\src\wolframe.lib
counterTest.exe: counterTest.obj $(TOPDIR)\src\wolframe.lib
resolvePathTest.exe: resolvePathTest.obj $(TOPDIR)\src\wolframe.lib
testBoostPath.exe: testBoostPath.obj
singletonTest.exe: singletonTest.obj $(TOPDIR)\src\wolframe.lib
poolTest.exe: poolTest.obj $(TOPDIR)\src\wolframe.lib
testSHA2.exe: testSHA2.obj $(TOPDIR)\src\libwolframe\wolframe.lib
byte2hexTest.exe: byte2hexTest.obj $(TOPDIR)\src\libwolframe\wolframe.lib
CRAMtest.exe: CRAMtest.obj $(TOPDIR)\src\libwolframe\wolframe.lib
logTest.exe: logTest.obj $(TOPDIR)\src\wolframe.lib
protocolArgumentParsing.exe: protocolArgumentParsing.obj $(TOPDIR)\src\wolframe.lib
configStructParser.exe: configStructParser.obj $(TOPDIR)\src\wolframe.lib
configValueParser.exe: configValueParser.obj $(TOPDIR)\src\wolframe.lib
filter.exe: filter.obj $(TOPDIR)\src\wolframe.lib
testTimers.exe: testTimers.obj
testRand.exe: testRand.obj

local_all:

local_clean:
	@-erase test.bat logTest.log 2>NUL

local_distclean:

local_test:
	@-echo @echo off > test.bat
	@-echo PATH=%PATH%;$(BOOST_DIR)\Lib >> test.bat
	@-echo testNamedRetVal >> test.bat
	@-echo logTest >> test.bat
	@-echo versionTest >> test.bat
	@-echo counterTest >> test.bat
	@-echo resolvePathTest >> test.bat
	@-echo testBoostPath >> test.bat
	@-echo singletonTest >> test.bat
	@-echo testSHA2 >> test.bat
	@-echo byte2hexTest >> test.bat
	@-echo CRAMtest >> test.bat
	@-echo protocolArgumentParsing >> test.bat
	@-echo echo off >> test.bat
	@-test.bat

local_longtest:
	@-echo @echo off > test.bat
	@-echo PATH=%PATH%;$(BOOST_DIR)\Lib >> test.bat
	@-echo poolTest >> test.bat
	@-echo
	@-test.bat
